function [tot_pred1 ] = interp_pred_f_5_5_21(I_cur,S_cur,prs_cur)
%INTERPOLATING ALL THE FUNCTION RELATIONSHIPS WITH CURRENT AND SPONTANEOUS
%RATE THAT WERE OBSERVED:


I_S_t_PS_SP = [  0  131.0000    0.0000    0.0000    1.0000    1.0000
    4.5000  131.0000    -0.0002    0.0000    1.0000    1.0000
    9.5000  131.0000    -0.0006    0.0000    1.0000    1.0000
    13.5000  131.0000    -0.0008    0.0000    1.0000    1.0000
    18.0000  131.0000    -0.0008    0.0000    1.0000    1.0000
    22.5000  131.0000    -0.0008    0.0000    1.0000    1.0000
    27.0000  131.0000    -0.001    0.0001    1.0000    1.0000
    31.5000  131.0000    0.006    0.0006    1.0000    1.0000
    36.0000  131.0000    0.0037    0.0037    1.0000    1.0000
    40.5000  131.0000    0.0219    0.01    1.0000    1.0000
    45.0000  131.0000    0.1192    0.02    1.0000    1.0000
    49.5000  131.0000    0.4502    0.3    1.0000    1.0000
    54.0000  131.0000    0.8320    0.8320    1.0000    1.0000
    58.5000  131.0000    0.9677    0.9677    1.0000    1.0000
    63.0000  131.0000    0.9945    0.9945    1.0000    1.0000
    67.5000  131.0000    0.9991    0.9991    1.0000    1.0000
    72.0000  131.0000    0.9998    0.9998    1.0000    1.0000
    76.5000  131.0000    1.0000    1.0000    1.0000    1.0000
    81.0000  131.0000    1.0000    1.0000    1.0000    1.0000
    85.5000  131.0000    1.0000    1.0000    1.0000    1.0000
    90.0000  131.0000    1.0000    1.0000    1.0000    1.0000
    96.0000  131.0000    1.0000    1.0000    1.0000    1.0000
    108.0000  131.0000    1.0000    1.0000    1.0000    1.0000
    120.0000  131.0000    1.0000    1.0000    1.0000    1.0000
    132.0000  131.0000    1.0000    1.0000    1.0000    1.0000
    144.0000  131.0000    1.0000    1.0000    1.0000    1.0000
    156.0000  131.0000    1.0000    1.0000    0.9963    0.9963
    168.0000  131.0000    1.0000    1.0000    0.6900    0.6900
    180.0000  131.0000    1.0000    1.0000    0.0180    0.0180
    192.0000  131.0000    1.0000    1.0000    0.0002    0.0002
    204.0000  131.0000    1.0000    .5    0.0000    0.0000
    216.0000  131.0000    1.0000    .4    0.0000    0.0000
    228.0000  131.0000    1.0000    .34    0.0000    0.0000
    240.0000  131.0000    1.0000    .3    0.0000    0.0000
    252.0000  131.0000    1.0000    .3    0.0000    0.0000
    264.0000  131.0000    1.0000    .1    0.0000    0.0000
    276.0000  131.0000    1.0000    .1    0.0000    0.0000
    288.0000  131.0000    1.0000    .1    0.0000    0.0000
    300.0000  131.0000    1.0000    00    0.0000    0.0000
    312.0000  131.0000    1.0000    000    0.0000    0.0000
    324.0000  131.0000    1.0000    00    0.0000    0.0000
    336.0000  131.0000    1.0000    00    0.0000    0.0000
    348.0000  131.0000    1.0000    00    0.0000    0.0000
    360.0000  131.0000    1.0000    00    0.0000    0.0000
    500.0000  131.0000    1.0000    00    0.0000    0.0000
    
    0   85.9000    0.0000    0.0000    1.0000    1.0000
    4.5000   85.9000    0.0001    0.0001    1.0000    1.0000
    9.5000   85.9000    0.0002    0.003    1.0000    1.0000
    13.5000   85.9000    0.0003    0.004    1.0000    1.0000
    18.0000   85.9000    0.0005    0.01    1.0000    1.0000
    22.5000   85.9000    0.0008    0.2    1.0000    1.0000
    27.0000   85.9000    0.001    0.3    1.0000    1.0000
    31.5000   85.9000    0.0014    0.3    1.0000    1.0000
    36.0000   85.9000    0.0037    0.3    1.0000    1.0000
    40.5000   85.9000    0.0219    0.65    1.0000    1.0000
    45.0000   85.9000    0.1192    0.7    1.0000    1.0000
    49.5000   85.9000    0.4502    0.78    1.0000    1.0000
    54.0000   85.9000    0.8320    0.88    1.0000    1.0000
    58.5000   85.9000    0.9677    0.92    1.0000    1.0000
    63.0000   85.9000    0.9945    0.93    1.0000    1.0000
    67.5000   85.9000    0.9991    0.94   1.0000    1.0000
    72.0000   85.9000    0.9998    0.95   1.0000    1.0000
    76.5000   85.9000    1.0000    .96    1.0000    1.0000
    81.0000   85.9000    1.0000    .97    1.0000    1.0000
    85.5000   85.9000    1.0000    .98    1.0000    1.0000
    90.0000   85.9000    1.0000    1.0000    1.0000    1.0000
    96.0000   85.9000    1.0000    1.0000    1.0000    1.0000
    108.0000   85.9000    1.0000    1.0000    1.0000    1.0000
    120.0000   85.9000    1.0000    1.0000    1.0000    1.0000
    132.0000   85.9000    1.0000    1.0000    1.0000    1.0000
    144.0000   85.9000    1.0000    1.0000    1.0000    1.0000
    156.0000   85.9000    1.0000    1.0000    0.9963    0.9963
    168.0000   85.9000    1.0000    1.0000    0.6900    0.6900
    180.0000   85.9000    1.0000    1.0000    0.0180    0.0180
    192.0000   85.9000    1.0000    1.0000    0.0002    0.0002
    204.0000   85.9000    1.0000    1.0000    0.0000    0.0000
    216.0000   85.9000    1.0000    1.0000    0.0000    0.0000
    228.0000   85.9000    1.0000    .6    0.0000    0.0000
    240.0000   85.9000    1.0000    .55    0.0000    0.0000
    252.0000   85.9000    1.0000    .3    0.0000    0.0000
    264.0000   85.9000    1.0000    .3    0.0000    0.0000
    276.0000   85.9000    1.0000    .3    0.0000    0.0000
    288.0000   85.9000    1.0000    .3    0.0000    0.0000
    300.0000   85.9000    1.0000    .1    0.0000    0.0000
    312.0000   85.9000    1.0000    .1    0.0000    0.0000
    324.0000   85.9000    1.0000    .1    0.0000    0.0000
    336.0000   85.9000    1.0000    0    0.0000    0.0000
    348.0000   85.9000    1.0000    0    0.0000    0.0000
    360.0000   85.9000    1.0000    0    0.0000    0.0000
    500.0000   85.9000    1.0000    0    0.0000    0.0000
    
    0   55.6900    0.0000    0.000    1.0000    1.0000
    4.5000   55.6900    0.0001    0.001    1.0000    1.0000
    9.5000   55.6900    0.0004    0.001    1.0000    1.0000
    13.5000   55.6900    0.0008    0.001    1.0000    1.0000
    18.0000   55.6900    0.0014    0.001    1.0000    1.0000
    22.5000   55.6900    0.002    0.001    1.0000    1.0000
    27.0000   55.6900    0.003    0.3    1.0000    1.0000
    31.5000   55.6900    0.0035    0.4    1.0000    1.0000
    36.0000   55.6900    0.0035    0.4    1.0000    1.0000
    40.5000   55.6900    0.0036    0.4  1.0000    1.0000
    45.0000   55.6900    0.0037    0.4   1.0000    1.0000
    49.5000   55.6900    0.0045    0.41    1.0000    1.0000
    54.0000   55.6900    0.012    0.75    1.0000    1.0000
    58.5000   55.6900    0.9677    0.82    1.0000    1.0000
    63.0000   55.6900    0.9945    0.93    1.0000    1.0000
    67.5000   55.6900    0.9991    0.9991    1.0000    1.0000
    72.0000   55.6900    0.9998    0.9998    1.0000    1.0000
    76.5000   55.6900    1.0000    1.0000    1.0000    1.0000
    81.0000   55.6900    1.0000    1.0000    1.0000    1.0000
    85.5000   55.6900    1.0000    1.0000    1.0000    1.0000
    90.0000   55.6900    1.0000    1.0000    1.0000    1.0000
    96.0000   55.6900    1.0000    1.0000    1.0000    1.0000
    108.0000   55.6900    1.0000    1.0000    1.0000    1.0000
    120.0000   55.6900    1.0000    1.0000    1.0000    1.0000
    132.0000   55.6900    1.0000    1.0000    1.0000    1.0000
    144.0000   55.6900    1.0000    1.0000    1.0000    1.0000
    156.0000   55.6900    1.0000    1.0000    0.9963    0.9963
    168.0000   55.6900    1.0000    1.0000    0.6900    0.6900
    180.0000   55.6900    1.0000    1.0000    0.0180    0.0180
    192.0000   55.6900    1.0000    1.0000    0.0002    0.0002
    204.0000   55.6900    1.0000    1.0000    0.0000    0.0000
    216.0000   55.6900    1.0000    1.0000    0.0000    0.0000
    228.0000   55.6900    1.0000    .95    0.0000    0.0000
    240.0000   55.6900    1.0000    .88    0.0000    0.0000
    252.0000   55.6900    1.0000    .72    0.0000    0.0000
    264.0000   55.6900    1.0000    .35   0.0000    0.0000
    276.0000   55.6900    1.0000    .15    0.0000    0.0000
    288.0000   55.6900    1.0000    .1    0.0000    0.0000
    300.0000   55.6900    1.0000    .1    0.0000    0.0000
    312.0000   55.6900    1.0000    0    0.0000    0.0000
    324.0000   55.6900    1.0000    0    0.0000    0.0000
    336.0000   55.6900    1.0000    0    0.0000    0.0000
    348.0000   55.6900    1.0000    0    0.0000    0.0000
    360.0000   55.6900    1.0000    0    0.0000    0.0000
    500.0000   55.6900    1.0000    0    0.0000    0.0000
    
    0   29.4000    0.0000    0.0000    1.0000    1.0000
    4.5000   29.4000    0.0001    0.0000    1.0000    1.0000
    9.5000   29.4000    0.0003    0.01    1.0000    1.0000
    13.5000   29.4000    0.0005    0.01    1.0000    1.0000
    18.0000   29.4000    0.0013    0.01    1.0000    1.0000
    22.5000   29.4000    0.0018    0.01    1.0000    1.0000
    27.0000   29.4000    0.0022    0.2    1.0000    1.0000
    31.5000   29.4000    0.0045    0.28    1.0000    1.0000
    36.0000   29.4000    0.005    0.36    1.0000    1.0000
    40.5000   29.4000    0.0219    0.8    1.0000    1.0000
    45.0000   29.4000    0.1192    0.8    1.0000    1.0000
    49.5000   29.4000    0.4502    0.85    1.0000    1.0000
    54.0000   29.4000    0.8320    0.88    1.0000    1.0000
    58.5000   29.4000    0.9677    .9     1.0000    1.0000
    63.0000   29.4000    0.9945    1      1.0000    1.0000
    67.5000   29.4000    1          1      1.0000    1.0000
    72.0000   29.4000    1         1    1.0000    1.0000
    76.5000   29.4000    1.0000    1.0000    1.0000    1.0000
    81.0000   29.4000    1          1.0000    1.0000    1.0000
    85.5000   29.4000    1.0000    1.0000    1.0000    1.0000
    90.0000   29.4000    1.0000    1.0000    1.0000    1.0000
    96.0000   29.4000    1.0000    1.0000    1.0000    1.0000
    108.0000   29.4000    1.0000    1.0000    1.0000    1.0000
    120.0000   29.4000    1.0000    1.0000    1.0000    1.0000
    132.0000   29.4000    1.0000    1.0000    1.0000    1.0000
    144.0000   29.4000    1.0000    1.0000    1.0000    1.0000
    156.0000   29.4000    1.0000    1.0000    0.9963    0.9963
    168.0000   29.4000    1.0000    1.0000    0.6900    0.6900
    180.0000   29.4000    1.0000    1.0000    0.0180    0.0180
    192.0000   29.4000    1.0000    1.0000    0.0002    0.0002
    204.0000   29.4000    1.0000    1.0000    0.0000    0.0000
    216.0000   29.4000    1.0000    1.0000    0.0000    0.0000
    228.0000   29.4000    1.0000    1.0000    0.0000    0.0000
    240.0000   29.4000    1.0000    1.0000    0.0000    0.0000
    252.0000   29.4000    1.0000    1.000    0.0000    0.0000
    264.0000   29.4000    1.0000    .8000    0.0000    0.0000
    276.0000   29.4000    1.0000    .4000    0.0000    0.0000
    288.0000   29.4000    1.0000    .200    0.0000    0.0000
    300.0000   29.4000    1.0000    .1000    0.0000    0.0000
    312.0000   29.4000    1.0000    0000    0.0000    0.0000
    324.0000   29.4000    1.0000    0000    0.0000    0.0000
    336.0000   29.4000    1.0000    0000    0.0000    0.0000
    348.0000   29.4000    1.0000    0000    0.0000    0.0000
    360.0000   29.4000    1.0000    0000    0.0000    0.0000
    500.0000   29.4000    1.0000    0000    0.0000    0.0000
    
    0   12.9000    0.000    0.0000    1.0000    1.0000
    4.5000   12.9000    0.0001    0.0001    1.0000    1.0000
    9.5000   12.9000    0.0002    0.0001    1.0000    1.0000
    13.5000   12.9000    0.0003   0.0001    1.0000    1.0000
    18.0000   12.9000    0.0006    0.0001    1.0000    1.0000
    22.5000   12.9000    0.001    0.0001    1.0000    1.0000
    27.0000   12.9000    0.0018    0.0006    1.0000    1.0000
    31.5000   12.9000    0.0022    0.26    1.0000    1.0000
    36.0000   12.9000    0.0042    0.3    1.0000    1.0000
    40.5000   12.9000    0.0219    0.4    1.0000    1.0000
    45.0000   12.9000    0.1192    0.68    1.0000    1.0000
    49.5000   12.9000    0.4502    0.85    1.0000    1.0000
    54.0000   12.9000    0.8320    0.95    1.0000    1.0000
    58.5000   12.9000    0.9677    0.96    1.0000    1.0000
    63.0000   12.9000    0.9945    0.97    1.0000    1.0000
    67.5000   12.9000    0.9991    0.9991    1.0000    1.0000
    72.0000   12.9000    0.9998    0.9998    1.0000    1.0000
    76.5000   12.9000    1.0000    1.0000    1.0000    1.0000
    81.0000   12.9000    1.0000    1.0000    1.0000    1.0000
    85.5000   12.9000    1.0000    1.0000    1.0000    1.0000
    90.0000   12.9000    1.0000    1.0000    1.0000    1.0000
    96.0000   12.9000    1.0000    1.0000    1.0000    1.0000
    108.0000   12.9000    1.0000    1.0000    1.0000    1.0000
    120.0000   12.9000    1.0000    1.0000    1.0000    1.0000
    132.0000   12.9000    1.0000    1.0000    1.0000    1.0000
    144.0000   12.9000    1.0000    1.0000    1.0000    1.0000
    156.0000   12.9000    1.0000    1.0000    0.9963    0.9963
    168.0000   12.9000    1.0000    1.0000    0.6900    0.6900
    180.0000   12.9000    1.0000    1.0000    0.0180    0.0180
    192.0000   12.9000    1.0000    1.0000    0.0002    0.0002
    204.0000   12.9000    1.0000    1.0000    0.0000    0.0000
    216.0000   12.9000    1.0000    1.0000    0.0000    0.0000
    228.0000   12.9000    1.0000    1.0000    0.0000    0.0000
    240.0000   12.9000    1.0000    0.95    0.0000    0.0000
    252.0000   12.9000    1.0000    0.95    0.0000    0.0000
    264.0000   12.9000    1.0000    0.94    0.0000    0.0000
    276.0000   12.9000    1.0000    0.8    0.0000    0.0000
    288.0000   12.9000    1.0000    0.3    0.0000    0.0000
    300.0000   12.9000    1.0000    0.08    0.0000    0.0000
    312.0000   12.9000    1.0000    0.0    0.0000    0.0000
    324.0000   12.9000    1.0000    0    0.0000    0.0000
    336.0000   12.9000    1.0000    0    0.0000    0.0000
    348.0000   12.9000    1.0000    0    0.0000    0.0000
    360.0000   12.9000    1.0000    0    0.0000    0.0000
    500.0000   12.9000    1.0000    0    0.0000    0.0000
    
    0    7.0500    0.0000    0.0000    1.0000    1.0000
    4.5000    7.0500    0.0001     0.03    1.0000    1.0000
    9.5000    7.0500    0.0002     0.03    1.0000    1.0000
    13.5000    7.0500    0.0003     0.05    1.0000    1.0000
    18.0000    7.0500    0.0006      0.06    1.0000    1.0000
    22.5000    7.0500    0.0008      0.08   1.0000    1.0000
    27.0000    7.0500    0.0012      0.11    1.0000    1.0000
    31.5000    7.0500    0.0016      0.18   1.0000    1.0000
    36.0000    7.0500    0.0020       0.27    1.0000    1.0000
    40.5000    7.0500    0.004      0.3   1.0000    1.0000
    45.0000    7.0500    0.004       0.3    1.0000    1.0000
    49.5000    7.0500    0.001       .55    1.0000    1.0000
    54.0000    7.0500    0.3       1       1.0000    1.0000
    58.5000    7.0500    0.05       1       1.0000    1.0000
    63.0000    7.0500    .99        1         1.0000    1.0000
    67.5000    7.0500    0.9991    1       1.0000    1.0000
    72.0000    7.0500    1         1        1.0000    1.0000
    76.5000    7.0500    1.0000    1.0000    1.0000    1.0000
    81.0000    7.0500    1.0000    1.0000    1.0000    1.0000
    85.5000    7.0500    1.0000    1.0000    1.0000    1.0000
    90.0000    7.0500    1.0000    1.0000    1.0000    1.0000
    96.0000    7.0500    1.0000    1.0000    1.0000    1.0000
    108.0000    7.0500    1.0000    1.0000    1.0000    1.0000
    120.0000    7.0500    1.0000    1.0000    1.0000    1.0000
    132.0000    7.0500    1.0000    1.0000    1.0000    1.0000
    144.0000    7.0500    1.0000    1.0000    1.0000    1.0000
    156.0000    7.0500    1.0000    1.0000    0.9963    0.9963
    168.0000    7.0500    1.0000    1.0000    0.6900    0.6900
    180.0000    7.0500    1.0000    1.0000    0.0180    0.0180
    192.0000    7.0500    1.0000    1.0000    0.0002    0.0002
    204.0000    7.0500    1.0000    1.0000    0.0000    0.0000
    216.0000    7.0500    1.0000    1.0000    0.0000    0.0000
    228.0000    7.0500    1.0000    1.0000    0.0000    0.0000
    240.0000    7.0500    1.0000    1.0000    0.0000    0.0000
    252.0000    7.0500    1.0000    1.0000    0.0000    0.0000
    264.0000    7.0500    1.0000    1.0000    0.0000    0.0000
    276.0000    7.0500    1.0000    .9       0.0000    0.0000
    288.0000    7.0500    1.0000    .35      0.0000    0.0000
    300.0000    7.0500    1.0000    .1      0.0000    0.0000
    312.0000    7.0500    1.0000    0       0.0000    0.0000
    324.0000    7.0500    1.0000    0       0.0000    0.0000
    336.0000    7.0500    1.0000    0       0.0000    0.0000
    348.0000    7.0500    1.0000    0      0.0000    0.0000
    360.0000    7.0500    1.0000    0       0.0000    0.0000
    500.0000    7.0500    1.0000    0       0.0000    0.0000
    
    0         0    0.0000    0.0000    1.0000    1.0000
    4.5000         0    0.0000    0.0000    1.0000    1.0000
    9.5000         0    0.0000    0.0000    1.0000    1.0000
    13.5000         0    0.0000    0.0000    1.0000    1.0000
    18.0000         0    0.0000    0.0000    1.0000    1.0000
    22.5000         0    0.0000    0.0000    1.0000    1.0000
    27.0000         0    0.0001    0.0001    1.0000    1.0000
    31.5000         0    0.0006    0.0006    1.0000    1.0000
    36.0000         0    0.0037    0.0037    1.0000    1.0000
    40.5000         0    0.01      0.01        1.0000    1.0000
    45.0000         0    0.01      0.06      1.0000    1.0000
    49.5000         0    0.016      0.8       1.0000    1.0000
    54.0000         0    0.043      0.84      1.0000    1.0000
    58.5000         0    0.08      1      1.0000    1.0000
    63.0000         0    0.3        1    1.0000    1.0000
    67.5000         0    0.9991     1        1.0000    1.0000
    72.0000         0    0.9998    0.9998    1.0000    1.0000
    76.5000         0    1.0000    1.0000    1.0000    1.0000
    81.0000         0    1.0000    1.0000    1.0000    1.0000
    85.5000         0    1.0000    1.0000    1.0000    1.0000
    90.0000         0    1.0000    1.0000    1.0000    1.0000
    96.0000         0    1.0000    1.0000    1.0000    1.0000
    108.0000         0    1.0000    1.0000    1.0000    1.0000
    120.0000         0    1.0000    1.0000    1.0000    1.0000
    132.0000         0    1.0000    1.0000    1.0000    1.0000
    144.0000         0    1.0000    1.0000    1.0000    1.0000
    156.0000         0    1.0000    1.0000    0.9963    0.9963
    168.0000         0    1.0000    1.0000    0.6900    0.6900
    180.0000         0    1.0000    1.0000    0.0180    0.0180
    192.0000         0    1.0000    1.0000    0.0002    0.0002
    204.0000         0    1.0000    1.0000    0.0000    0.0000
    216.0000         0    1.0000    1.0000    0.0000    0.0000
    228.0000         0    1.0000    1.0000    0.0000    0.0000
    240.0000         0    1.0000    1.0000    0.0000    0.0000
    252.0000         0    1.0000    1.0000    0.0000    0.0000
    264.0000         0    1.0000    1.0000    0.0000    0.0000
    276.0000         0    1.0000    1.0000    0.0000    0.0000
    288.0000         0    1.0000    1.0000    0.0000    0.0000
    300.0000         0    1.0000    0    0.0000    0.0000
    312.0000         0    1.0000    0    0.0000    0.0000
    324.0000         0    1.0000    0    0.0000    0.0000
    336.0000         0    1.0000    0    0.0000    0.0000
    348.0000         0    1.0000    0    0.0000    0.0000
    360.0000         0    1.0000    0    0.0000    0.0000
    500.0000         0    1.0000    0    0.0000    0.0000];

%%
% I_shift_scale_S = [1.13 1.13 1.13 1.13 1.08 1.03 1];
% full_mat = [];
% for n_s = 1:7
%     tmp_mat = [q(:,1) repmat(Ss(n_s),[length(q) 1]) q(:,2)]
%    % tmp_mat = [q repmat(Ss(n_s),[length(q) 1]) sigmf(q,[.4 50]) sigmf(q,[.4 50]) sigmf(q,[-.4 170]) sigmf(q,[-.4 170])];
%     full_mat = vertcat(full_mat,tmp_mat);
% end
%%
plot_it = 1;
%%%%%%% VARIABLES THAT CHANGE WITH CURRENT %%%%%%%%%%%%%%%%%%%%

I_in_t_block =   [
    0  131.0000  200.0000
    4.5000  131.0000   25.0000
    9.0000  131.0000   25.0000
    13.5000  131.0000   25.0000
    18.0000  131.0000   25.0000
    22.5000  131.0000   14.0000
    27.0000  131.0000   13.0000
    31.5000  131.0000   12.0000
    36.0000  131.0000   11.0000
    40.5000  131.0000   10.0000
    45.0000  131.0000   9.9000
    49.5000  131.0000   6.0000
    54.0000  131.0000   5.5000
    58.5000  131.0000   5.400
    63.0000  131.0000    5.4000
    67.5000  131.0000    5.4000
    72.0000  131.0000    5.4000
    76.5000  131.0000    5.4000
    81.0000  131.0000    5.4000
    85.5000  131.0000    5.4000
    90.0000  131.0000    5.4000
    
    96.0000  131.0000    4.8000
    108.0000  131.0000    4.7600
    120.0000  131.0000    4.7500
    132.0000  131.0000    4.400
    144.0000  131.0000    4.7100
    156.0000  131.0000    4.7300
    168.0000  131.0000    4.7300
    180.0000  131.0000    4.7300
    192.0000  131.0000    4.7300
    204.0000  131.0000    4.7300
    216.0000  131.0000    5.1502
    228.0000  131.0000    5.1852
    240.0000  131.0000    5.5000
    252.0000  131.0000    6.2000
    264.0000  131.0000    7.0000
    276.0000  131.0000    7.7000
    288.0000  131.0000    8.3000
    300.0000  131.0000   16.2580
    312.0000  131.0000   31.6985
    324.0000  131.0000   68.5536
    336.0000  131.0000  156.5234
    348.0000  131.0000  366.4995
    360.0000  131.0000  867.6938
    500.0000  131.0000  867.6938
    
    0        85.9000  200.0000
    4.5000   85.9000   25.0000
    9.0000   85.9000   25.0000
    13.5000   85.9000   25.0000
    18.0000   85.9000   25.0000
    22.5000   85.9000   25.0000
    27.0000   85.9000   25.0000
    31.5000   85.9000   20.0000
    36.0000   85.9000   16.0000
    40.5000   85.9000   13.0000
    45.0000   85.9000   13.0000
    49.5000   85.9000   12.0000
    54.0000   85.9000   12.2000
    58.5000   85.9000   12.000
    63.0000   85.9000    9.5000
    67.5000   85.9000    8.0000
    72.0000   85.9000    4.3000
    76.5000   85.9000    4.3000
    81.0000   85.9000    4.4000
    85.5000   85.9000    4.3000
    90.0000   85.9000    4.3000
    
    96.0000   85.9000    4.3000
    108.0000   85.9000    4.300
    120.0000   85.9000    4.00
    132.0000   85.9000    4.00
    144.0000   85.9000    4.100
    156.0000   85.9000    4.200
    168.0000   85.9000    4.300
    180.0000   85.9000    4.300
    192.0000   85.9000    4.300
    204.0000   85.9000    4.300
    216.0000   85.9000    5.22
    228.0000   85.9000    6.4
    240.0000   85.9000    7.000
    252.0000   85.9000    13.0000
    264.0000   85.9000    13.0000
    276.0000   85.9000    13.3000
    288.0000   85.9000    13.3000
    300.0000   85.9000   13.30
    312.0000   85.9000   13.5
    324.0000   85.9000   13.5536
    336.0000   85.9000   13.6
    348.0000   85.9000  366.4995
    360.0000   85.9000  867.6938
    500.0000   85.9000  867.6938
    
    0   55.6900  200.0000
    4.5000   55.6900   30.0000
    9.0000   55.6900   30.0000
    13.5000   55.6900   30.0000
    18.0000   55.6900   30.0000
    22.5000   55.6900   29.0000
    27.0000   55.6900   28.0000
    31.5000   55.6900   27.0000
    36.0000   55.6900   27.0000
    40.5000   55.6900   23.0000
    45.0000   55.6900   16.0000
    49.5000   55.6900   14.0000
    54.0000   55.6900   13.2000
    58.5000   55.6900    10.500
    63.0000   55.6900    5.500
    67.5000   55.6900    5.300
    72.0000   55.6900    5.300
    76.5000   55.6900    5.2000
    81.0000   55.6900    5.000
    85.5000   55.6900    4.700
    90.0000   55.6900    4.700
    
    96.0000   55.6900    4.7000
    108.0000   55.6900    4.700
    120.0000   55.6900    4.700
    132.0000   55.6900    4.7100
    144.0000   55.6900    4.7100
    156.0000   55.6900    4.7300
    168.0000   55.6900    4.7300
    180.0000   55.6900    4.8500
    192.0000   55.6900    5.10
    204.0000   55.6900    5.1500
    216.0000   55.6900    5.1502
    228.0000   55.6900    5.8
    240.0000   55.6900    7.000
    252.0000   55.6900    8.0000
    264.0000   55.6900    8.0000
    276.0000   55.6900    9.0000
    288.0000   55.6900    13.000
    300.0000   55.6900   16.2580
    312.0000   55.6900   31.6985
    324.0000   55.6900   68.5536
    336.0000   55.6900  156.5234
    348.0000   55.6900  366.4995
    360.0000   55.6900  867.6938
    500.0000   55.6900  867.6938
    
    0       29.4000  200.0000
    4.5000   29.4000   25.0000
    9.0000   29.4000   25.0000
    13.5000   29.4000   25.0000
    18.0000   29.4000   25.0000
    22.5000   29.4000   25.0000
    27.0000   29.4000   18.0000
    31.5000   29.4000   18.0000
    36.0000   29.4000   17.0000
    40.5000   29.4000   15.0000
    45.0000   29.4000   13.75000
    49.5000   29.4000   7.80
    54.0000   29.4000   7.8
    58.5000   29.4000   7.600
    63.0000   29.4000    7.000
    67.5000   29.4000    6.1000
    72.0000   29.4000    5.8000
    76.5000   29.4000    5.5000
    81.0000   29.4000    5.3000
    85.5000   29.4000    5.2000
    90.0000   29.4000    5.000
    96.0000   29.4000    4.7000
    108.0000   29.4000    4.700
    120.0000   29.4000    4.700
    132.0000   29.4000    4.6500
    144.0000   29.4000    4.6500
    156.0000   29.4000    4.7300
    168.0000   29.4000    4.7300
    180.0000   29.4000    4.7300
    192.0000   29.4000    5.00
    204.0000   29.4000    5.00
    216.0000   29.4000    5.8
    228.0000   29.4000    6.2
    240.0000   29.4000    6.600
    252.0000   29.4000    7.000
    264.0000   29.4000    8.2000
    276.0000   29.4000    10.7000
    288.0000   29.4000    11.7000
    300.0000   29.4000   16.2580
    312.0000   29.4000   31.6985
    324.0000   29.4000   68.5536
    336.0000   29.4000  156.5234
    348.0000   29.4000  366.4995
    360.0000   29.4000  867.6938
    500.0000   29.4000  867.6938
    
    0   12.9000  200.0000
    4.5000   12.9000   25.0000
    9.0000   12.9000   25.0000
    13.5000   12.9000   25.0000
    18.0000   12.9000   25.0000
    22.5000   12.9000   25.0000
    27.0000   12.9000   25.0000
    31.5000   12.9000   20.0000
    36.0000   12.9000   20.0000
    40.5000   12.9000   18.7000
    45.0000   12.9000   17.8000
    49.5000   12.9000   12.6000
    54.0000   12.9000   11.600
    58.5000   12.9000   10.500
    63.0000   12.9000    8.800
    67.5000   12.9000    7.3000
    72.0000   12.9000    6.4000
    76.5000   12.9000    5.8000
    81.0000   12.9000    5.6000
    85.5000   12.9000    5.4000
    90.0000   12.9000    5.1000
    96.0000   12.9000    4.8000
    108.0000   12.9000    4.7600
    120.0000   12.9000    4.7500
    132.0000   12.9000    4.7100
    144.0000   12.9000    4.7100
    156.0000   12.9000    4.7300
    168.0000   12.9000    4.7500
    180.0000   12.9000    4.7800
    192.0000   12.9000    4.8200
    204.0000   12.9000    5.00
    216.0000   12.9000    5.302
    228.0000   12.9000    5.8
    240.0000   12.9000    6.3000
    252.0000   12.9000    7.000
    264.0000   12.9000    7.8000
    276.0000   12.9000    9.000
    288.0000   12.9000   11.3000
    300.0000   12.9000   15.0
    312.0000   12.9000   31.6985
    324.0000   12.9000   68.5536
    336.0000   12.9000  156.5234
    348.0000   12.9000  366.4995
    360.0000   12.9000  867.6938
    500.0000   12.9000  867.6938
    
    0         7.0500  200.0000
    4.5000    7.0500   25.0000
    9.0000    7.0500   25.0000
    13.5000    7.0500   25.0000
    18.0000    7.0500   25.0000
    22.5000    7.0500   25.0000
    27.0000    7.0500   25.0000
    31.5000    7.0500   20.0000
    36.0000    7.0500   20.0000
    40.5000    7.0500   18.0000
    45.0000    7.0500   16.0000
    49.5000    7.0500   13.0000
    54.0000    7.0500   13.2000
    58.5000    7.0500   12.000
    63.0000    7.0500    9.6000
    67.5000    7.0500    8.1000
    72.0000    7.0500    7.0000
    76.5000    7.0500    6.1000
    81.0000    7.0500    5.8000
    85.5000    7.0500    5.5000
    90.0000    7.0500    5.4000
    96.0000    7.0500    4.8000
    108.0000    7.0500    4.7600
    120.0000    7.0500    4.7500
    132.0000    7.0500    4.7100
    144.0000    7.0500    4.7100
    156.0000    7.0500    4.7300
    168.0000    7.0500    4.7300
    180.0000    7.0500    4.7600
    192.0000    7.0500    4.900
    204.0000    7.0500    5.00
    216.0000    7.0500    5.302
    228.0000    7.0500    5.352
    240.0000    7.0500    5.7000
    252.0000    7.0500    6.2000
    264.0000    7.0500    7.0000
    276.0000    7.0500    7.3000
    288.0000    7.0500    8.500
    300.0000    7.0500   13.2580
    312.0000    7.0500   31.6985
    324.0000    7.0500   68.5536
    336.0000    7.0500  156.5234
    348.0000    7.0500  366.4995
    360.0000    7.0500  867.6938
    500.0000    7.0500  867.6938
    
    0         0  200.0000
    4.5000         0   25.0000
    9.0000         0   25.0000
    13.5000         0   25.0000
    18.0000         0   25.0000
    22.5000         0   25.0000
    27.0000         0   25.0000
    31.5000         0   20.0000
    36.0000         0   20.0000
    40.5000         0   20.0000
    45.0000         0   20.0000
    49.5000         0   14.5000
    54.0000         0   13.40
    58.5000         0   12.6
    63.0000         0    10.250
    67.5000         0    8.6000
    72.0000         0    7.0000
    76.5000         0    6.1000
    81.0000         0    5.8000
    85.5000         0    5.5000
    90.0000         0    5.4000
    96.0000         0    4.8000
    108.0000         0    4.7600
    120.0000         0    4.7500
    132.0000         0    4.7100
    144.0000         0    4.7100
    156.0000         0    4.7300
    168.0000         0    4.7300
    180.0000         0    4.7300
    192.0000         0    4.7300
    204.0000         0    4.7300
    216.0000         0    5.1502
    228.0000         0    5.1852
    240.0000         0    5.5000
    252.0000         0    6.2000
    264.0000         0    7.0000
    276.0000         0    7.7000
    288.0000         0    8.3000
    300.0000         0   16.2580
    312.0000         0   31.6985
    324.0000         0   68.5536
    336.0000         0  156.5234
    348.0000         0  366.4995
    360.0000         0  867.6938
    500.0000         0  867.6938];
x_range_tblck(1).range = [0:.1:400];%max(I_in)];


% % % % FOR COMPARISON IF FIT WITH A FUNCTION:
% % % switch_pt = [93 204 215 260 293];% 260];%288];%switch 1-->2, 2-->3
% % %
% % %  %For S < (29) n_rat =4
% % %  if (S < 29) & (I_cur < 90)
% % %  t_block_f_90 = @(I) max(min(exp(-.087*(I- 83.5)) + 4.5, 37),5.45);
% % %  else
% % %  %Edit 4/22/21 - shallower
% % %  t_block_f_90 = @(I) max(min(exp(-.06*(I- 85)) + 4, 37),5.45);
% % %  end
% % % %Connects low and high smoothly:
% % % spline_2 = @(I_in,mid_switch) 4.725 + ((5.1-4.725)*((I_in - mid_switch(2)))/(mid_switch(3)-mid_switch(2))).*((I_in >= mid_switch(2))&(I_in < mid_switch(3)));
% % %
% % %
% % % t_block_fun = @(I_in,mid_switch) (I_in<=mid_switch(1)).*t_block_f_90(I_in)  + ...
% % %     (90*exp(-.1*(I_in-28)) + 4.725).*((I_in < mid_switch(2))& (I_in > mid_switch(1))) +...
% % %     + spline_2(I_in,mid_switch).*((I_in < mid_switch(3))& (I_in >= mid_switch(2))) ...
% % %     + (5.1+ 1.8*sigmf(I_in,[.16 250])).*((I_in >= mid_switch(3)) & (I_in < mid_switch(4))) ...
% % %     + (exp(.04*(I_in -275)) + 6.3).*(I_in >= mid_switch(4));

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%t before block for partial elimination for bend 1 (3)
%t before block for partial elimination for bend 2 on (keep fixed for
%simplicity) (4)
prt_elim_S =  [ 0  131.0000    0.9000    0.9000
    0   85.0000    0.0100    0.0100
    0   55.0000    0.0100    0.0100
    0   30.0000    0.0100    0.0100
    0   13.4000    0.0100    0.0100
    0    5.8800    0.0100    0.0100
    0         0    0.0100    0.0100
    4.5000  131.0000    0.4000    0.7000
    4.5000   85.0000    0.0100    0.0100
    4.5000   55.0000    0.0100    0.0100
    4.5000   30.0000    0.0100    0.0100
    4.5000   13.4000    0.0100    0.0100
    4.5000    5.8800    0.0100    0.0100
    4.5000         0    0.0100    0.0100
    9.0000  131.0000    0.0100    0.0100
    9.0000   85.0000    0.0100    0.0100
    9.0000   55.0000    0.0100    0.0100
    9.0000   30.0000    0.0100    0.0100
    9.0000   13.4000    0.0100    0.0100
    9.0000    5.8800    0.0100    0.0100
    9.0000         0    0.0100    0.0100
    13.5000  131.0000    0.0100    0.0100
    13.5000   85.0000    0.0100    0.0100
    13.5000   55.0000    0.0100    0.0100
    13.5000   40.0000    0.0100    0.0100
    13.5000   13.4000    0.0100    0.0100
    13.5000    5.8800    0.0100    0.0100
    13.5000         0    0.0100    0.0100
    18.0000  131.0000    0.0100    0.0100
    18.0000   85.0000    0.0100    0.0100
    18.0000   55.0000    0.0100    0.0100
    18.0000   30.0000    0.0100    0.0100
    18.0000   13.4000    0.0100    0.0100
    18.0000    5.8800    0.0100    0.0100
    18.0000         0    0.0100    0.0100
    22.5000  131.0000    0.0100    0.0100
    22.5000   85.0000    0.0100    0.0100
    22.5000   55.0000    0.0100    0.0100
    22.5000   30.0000    0.0100    0.0100
    22.5000   13.4000    0.0100    0.0100
    22.5000    5.8800    0.0100    0.0100
    22.5000         0    0.0100    0.0100
    27.0000  131.0000    0.0100    0.0100
    27.0000   85.0000    0.0100    0.0100
    27.0000   55.0000    0.0100    0.0100
    27.0000   40.0000    0.0100    0.6
    27.0000   13.4000    0.0100    0.4
    27.0000    5.8800    0.100    0.400
    27.0000         0    0.0100    0.0100
    
    31.5000  131.0000    0.0100    0.0100
    31.5000   85.0000    0.0100    0.0100
    31.5000   55.0000    0.0100    0.0100
    31.5000   30.0000    0.0100    0.8
    31.5000   13.4000    0.0100    0.0100
    31.5000    5.8800    0.100    0.400
    31.5000         0    0.0100    0.0100
    36.0000  131.0000    0.9000    0.7000
    36.0000   85.0000    0.0100    0.0100
    36.0000   55.0000    0.0100    0.0100
    36.0000   30.0000    0.0100    0.6
    36.0000   13.4000    0.8000    0.7000
    36.0000    5.8800    0.100    0.900
    36.0000         0    0.0100    0.0100
    40.5000  131.0000    0.8000    0.7000
    40.5000   85.0000    0.4    0.7
    40.5000   55.0000    0.200    0.900
    40.5000   40.0000    0.2000    0.9500
    40.5000   13.4000    0.8000    0.7000
    40.5000    5.8800    0.100    0.600
    40.5000         0    0.0100    0.0100
    45.0000  131.0000    0.6000    0.3000
    45.0000   85.0000    0.4    0.7
    45.0000   55.0000    0.600    0.900
    45.0000   30.0000    0.7000    0.9300
    45.0000   13.4000    0.8000    0.7000
    45.0000    5.8800    0.9000    0.8000
    45.0000         0    0.0100    0.7000
    49.5000  131.0000    0.2000    0.5000
    49.5000   85.0000    0.4    0.7
    49.5000   55.0000    0.500    0.900
    49.5000   30.0000    0.5       0.9900
    49.5000   13.4000    0.58000    0.7500
    49.5000    5.8800    0.5800    0.7500
    49.5000         0    0.3500    0.6000
    54.0000  131.0000    0.25    0.6700
    54.0000   85.0000    0.34    0.8
    54.0000   55.0000    0.3400    0.800
    54.0000   30.0000    0.53    0.9900
    54.0000   13.4000    0.5000    0.8000
    54.0000    5.8800    0.5800    0.9300
    54.0000         0    0.3500    0.6000
    58.5000  131.0000    0.25   0.8000
    58.5000   85.0000    0.2300    0.8000
    58.5000   55.0000    0.5000    0.700
    58.5000   30.0000    0.53    0.9900
    58.5000   13.4000    0.4300    0.7500
    58.5000    5.8800    0.4500    0.7000
    58.5000         0    0.3000    0.6500
    63.0000  131.0000    0.25000    0.7000
    63.0000   85.0000    0.3600    0.7800
    63.0000   55.0000    0.460    0.7500
    63.0000   30.0000    0.4600    0.9900
    63.0000   13.4000    0.3700    0.7000
    63.0000    5.8800    0.3000    0.5700
    63.0000         0    0.300    0.5500
    67.5000  131.0000    0.2700    0.55000
    67.5000   85.0000    0.3600    0.8000
    67.5000   55.0000    0.3800    0.8000
    67.5000   30.0000    0.3800    0.8500
    67.5000   13.4000    0.3000    0.7600
    67.5000    5.8800    0.2200    0.5500
    67.5000         0    0.1900    0.4600
    72.0000  131.0000    0.270    0.7000
    72.0000   85.0000    0.45    0.8000
    72.0000   55.0000    0.3200    0.7000
    72.0000   30.0000    0.3200    0.7000
    72.0000   13.4000    0.2600    0.6000
    72.0000    5.8800    0.2000    0.4700
    72.0000         0    0.1500    0.4000
    76.5000  131.0000    0.2900    0.6500
    76.5000   85.0000    0.45    0.75
    76.5000   55.0000    0.330    0.5800
    76.5000   30.0000    0.2600    0.5500
    76.5000   13.4000    0.2400    0.5500
    76.5000    5.8800    0.1800    0.4200
    76.5000         0    0.1500    0.3500
    81.0000  131.0000    0.3      0.65
    81.0000   85.0000    0.4300    0.75
    81.0000   55.0000    0.3000    0.55000
    81.0000   30.0000    0.2100    0.45
    81.0000   13.4000    0.2000    0.4000
    81.0000    5.8800    0.1700    0.3600
    81.0000         0    0.1500    0.2900
    85.5000  131.0000    0.300    0.5500
    85.5000   85.0000    0.4500    0.75
    85.5000   55.0000    0.300    0.5500
    85.5000   30.0000    0.2400    0.42
    85.5000   13.4000    0.1600    0.2500
    85.5000    5.8800    0.1200    0.2300
    85.5000         0    0.1200    0.2300
    90.0000  131.0000    0.3000    0.5000
    90.0000   85.0000    0.4300    0.7
    90.0000   55.0000    0.300    0.4500
    90.0000   30.0000    0.2000    0.4
    90.0000   13.4000    0.1800    0.4100
    90.0000    5.8800    0.0800    0.1300
    90.0000         0    0.0800    0.0100
    
    96.0000  131.7647    0.3700    0.6600
    96.0000   84.4700    0.4300    0.7
    96.0000   55.5000    0.2200    0.3800
    96.0000   30.8000    0.2000    0.0100
    96.0000   13.4000    0.1900    0.0100
    96.0000    5.8800    0.1724    0.0100
    96.0000         0    0.1300    0.0100
    108.0000  131.7647    0.3800    0.69
    108.0000   84.4700    0.4200    0.700
    108.0000   55.5000    0.2200    0.0100
    108.0000   30.8000    0.1800    0.0100
    108.0000   13.4000    0.1600    0.0100
    108.0000    5.8800    0.1400    0.0100
    108.0000         0    0.1200    0.0100
    120.0000  131.7647    0.38    0.75
    120.0000   84.4700    0.5000    0.7000
    120.0000   55.5000    0.2200    0.0100
    120.0000   30.8000    0.1900    0.0100
    120.0000   13.4000    0.1700    0.0100
    120.0000    5.8800    0.1400    0.0100
    120.0000         0    0.1250    0.0100
    132.0000  131.7647    0.4000    0.7
    132.0000   84.4700    0.5000    0.7000
    132.0000   55.5000    0.2500    0.0100
    132.0000   30.8000    0.2200    0.0100
    132.0000   13.4000    0.1700    0.0100
    132.0000    5.8800    0.1500    0.0100
    132.0000         0    0.1398    0.0100
    144.0000  131.7647    0.3600    0.6500
    144.0000   84.4700    0.51    0.7000
    144.0000   55.5000    0.2800    0.0100
    144.0000   30.8000    0.2471    0.0100
    144.0000   13.4000    0.1800    0.0100
    144.0000    5.8800    0.1758    0.0100
    144.0000         0    0.1398    0.0100
    156.0000  131.7647    0.4000    0.7000
    156.0000   84.4700    0.51    0.700
    156.0000   55.5000    0.3100    0.0100
    156.0000   30.8000    0.2471    0.0100
    156.0000   13.4000    0.2000    0.0100
    156.0000    5.8800    0.1500    0.0100
    156.0000         0    0.1500    0.0100
    168.0000  131.7647    0.4000    0.7000
    168.0000   84.4700    0.52    0.7000
    168.0000   55.5000    0.3600    0.4000
    168.0000   30.8000    0.2564    0.0100
    168.0000   13.4000    0.2099    0.0100
    168.0000    5.8800    0.1900    0.0100
    168.0000         0    0.1900    0.0100
    180.0000  131.7647    0.380    0.6500
    180.0000   84.4700    0.5500    0.700
    180.0000   55.5000    0.3400    0.4000
    180.0000   30.8000    0.3056    0.0100
    180.0000   13.4000    0.2600    0.0100
    180.0000    5.8800    0.2300    0.0100
    180.0000         0    0.2300    0.0100
    192.0000  131.7647    0.3500    0.5600
    192.0000   84.4700    0.5300    0.700
    192.0000   55.5000    0.3200    0.3000
    192.0000   30.8000    0.2857    0.0100
    192.0000   13.4000    0.2700    0.0100
    192.0000    5.8800    0.2700    0.0100
    192.0000         0    0.2700    0.0100
    204.0000  131.7647    0.4000    0.7
    204.0000   84.4700    0.5300    0.800
    204.0000   55.5000    0.4300    0.4000
    204.0000   30.8000    0.4       0.4000
    204.0000   13.4000    0.3000    0.3
    204.0000    5.8800    0.2800    0.3000
    204.0000         0    0.3000    0.0100
    216.0000  131.7647    0.4000    0.7000
    216.0000   84.4700    0.5000    0.6000
    216.0000   55.5000    0.4300    0.4500
    216.0000   30.8000    0.2857    0.280
    216.0000   13.4000    0.3000    0.3200
    216.0000    5.8800    0.2800    0.2500
    216.0000         0    0.2800    0.0100
    228.0000  131.7647    0.4000    0.85
    228.0000   84.4700    0.4000    0.3000
    228.0000   55.5000    0.400     0.6000
    228.0000   30.8000    0.3000    0.2100
    228.0000   13.4000    0.3000    0.2600
    228.0000    5.8800    0.3200    0.3000
    228.0000         0    0.2800    0.0010
    240.0000  131.7647    0.4000    0.9
    240.0000   84.4700    0.4000    0.5000
    240.0000   55.5000    0.4200    0.3800
    240.0000   30.8000    0.3208    0.2100
    240.0000   13.4000    0.3000    0.2500
    240.0000    5.8800    0.3200    0.2500
    240.0000         0    0.3000    0.1700
    252.0000  131.7647    0.300    0.0932
    252.0000   84.4700    0.4107    0.4000
    252.0000   55.5000    0.4500    0.5000
    252.0000   30.8000    0.3617    0.2800
    252.0000   13.4000    0.3000    0.3000
    252.0000    5.8800    0.3000    0.300
    252.0000         0    0.2900    0.0100
    264.0000  131.7647    0.300    0.0100
    264.0000   84.4700    0.3000    0.4000
    264.0000   55.5000    0.5000    0.5000
    264.0000   30.8000    0.4000    0.4000
    264.0000   13.4000    0.3400    0.4800
    264.0000    5.8800    0.3000    0.4800
    264.0000         0    0.2600    0.001
    
    276.0000  131.7647    0.0100    0.0100
    276.0000   84.4700    0.3    0.7000
    276.0000   55.5000    0.9000    0.4000
    276.0000   30.8000    0.5000    0.4500
    276.0000   13.4000    0.4118    0.6000
    276.0000    5.8800    0.4500    0.9000
    276.0000         0    0.330    0.150
    
    288.0000  131.7647    0.0100    0.0100
    288.0000   84.4700    0.300     0.6000
    288.0000   55.5000    0.7000    0.7000
    288.0000   30.8000    0.9821    0.6000
    288.0000   13.4000    0.7241    0.6000
    288.0000    5.8800    0.5000    0.9900
    288.0000         0    0.500     0.500
    
    300.0000  131.7647    0.0100    0.0100
    300.0000   84.4700    0.300    0.500
    300.0000   55.5000    0.7000    0.7000
    300.0000   30.8000    0.9900    0.7000
    300.0000   13.4000    0.9000    0.9000
    300.0000    5.8800    0.9000    0.9000
    300.0000         0    0.0100    0.0100
    312.0000  131.7647    0.0100    0.0100
    312.0000   84.4700    0.300    0.500
    312.0000   55.5000    0.0100    0.0100
    312.0000   30.8000    0.0100    0.0100
    312.0000   13.4000    0.0100    0.0100
    312.0000    5.8800    0.0100    0.0100
    312.0000         0    0.0100    0.0100
    324.0000  131.7647    0.0100    0.0100
    324.0000   84.4700    0.300    0.500
    324.0000   55.5000    0.0100    0.0100
    324.0000   30.8000    0.0100    0.0100
    324.0000   13.4000    0.0100    0.0100
    324.0000    5.8800    0.0100    0.0100
    324.0000         0    0.0100    0.0100
    336.0000  131.7647    0.0100    0.0100
    336.0000   84.4700    0.0100    0.0100
    336.0000   55.5000    0.0100    0.0100
    336.0000   30.8000    0.0100    0.0100
    336.0000   13.4000    0.0100    0.0100
    336.0000    5.8800    0.0100    0.0100
    336.0000         0    0.0100    0.0100
    348.0000  131.7647    0.0100    0.0100
    348.0000   84.4700    0.0100    0.0100
    348.0000   55.5000    0.0100    0.0100
    348.0000   30.8000    0.0100    0.0100
    348.0000   13.4000    0.0100    0.0100
    348.0000    5.8800    0.0100    0.0100
    348.0000         0    0.0100    0.0100
    360.0000  131.7647    0.0100    0.0100
    360.0000   84.4700    0.0100    0.0100
    360.0000   55.5000    0.0100    0.0100
    360.0000   30.8000    0.0100    0.0100
    360.0000   13.4000    0.0100    0.0100
    360.0000    5.8800    0.0100    0.0100
    360.0000         0    0.0100    0.0100
    500.0000  131.7647    0.0100    0.0100
    500.0000   84.4700    0.0100    0.0100
    500.0000   55.5000    0.0100    0.0100
    500.0000   30.8000    0.0100    0.0100
    500.0000   13.4000    0.0100    0.0100
    500.0000    5.8800    0.0100    0.0100
    500.0000         0    0.0100    0.0100];

xs_range_prt_elim(1).range = [0:.1:max(prt_elim_S(:,1))];
xs_range_prt_elim(2).range = [0:.1:max(prt_elim_S(:,2))];

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Slope of Increase of pulses for each I and S (pre-PR = S)

up_slopes = [0	130	nan	0
    0	86	nan	0
    0	56	nan	0
    0	29	nan	0
    0	12	nan	0
    0	7	nan	0
    0	0	nan	0
    4.5	130	nan	-0.005714286
    4.5	86	nan	0.001428571
    4.5	56	nan	0
    4.5	29	nan	0
    4.5	12	nan	0
    4.5	7	nan	0
    4.5	0	nan	0
    9.5	130	nan	-0.017142857
    9.5	86	nan	0.005714286
    9.5	56	nan	0.005714286
    9.5	29	nan	0
    9.5	12	nan	0
    9.5	7	nan	0
    9.5	0	nan	0
    
    13.5	130	nan	-0.017142857
    13.5	86	nan	0.005714286
    13.5	56	nan	0.005714286
    13.5	29	nan	0
    13.5	12	nan	0
    13.5	7	nan	0
    13.5	0	nan	0
    18	130	nan	-0.017142857
    18	86	nan	0.007142857
    18	56	nan	0.017142857
    18	29	nan	0.011428571
    18	12	nan	0.005714286
    18	7	nan	0.005714286
    18	0	nan	0
    22.5	130	nan	-0.017142857
    22.5	86	nan	0.011428571
    22.5	56	nan	0.022857143
    22.5	29	nan	0.012857143
    22.5	12	nan	0.007142857
    22.5	7	nan	0.005714286
    22.5	0	nan	0
    27	130	nan	-0.02
    27	86	nan	0.017142857
    27	56	nan	0.034285714
    27	29	nan	0.028571429
    27	12	nan	0.017142857
    27	7	nan	0.012857143
    27	0	nan	0
    31.5	130	nan	-0.017142857
    31.5	86	nan	0.028571429
    31.5	56	nan	0.045714286
    31.5	29	nan	0.037142857
    31.5	12	nan	0.028571429
    31.5	7	nan	0.02
    31.5	0	nan	0
    36	130	184	-0.038043478
    36	86	130	0.009046154
    36	56	100	0.08627
    36	29	86	0.086627907
    36	12	86	0.072965116
    36	7	62	0.044274194
    36	0	0	0
    40.5	130	150	-0.033333333
    40.5	86	102	0.026911765
    40.5	56	96	0.102083333
    40.5	29	98	0.128061224
    40.5	12	78	0.1175
    40.5	7	76	0.067078947
    40.5	0	0	0
    45	130	152	-0.038697368
    45	86	170	0.055364706
    45	56	132	0.121818182
    45	29	110	0.187765957
    45	12	92	0.174782609
    45	7	82	0.12195122
    45	0	0	0
    49.5	130	130	-0.04668254
    49.5	86	140	0.058821429
    49.5	56	132	0.154469697
    49.5	29	110	0.242454545
    49.5	12	64	0.2940625
    49.5	7	54	0.246851852
    49.5	0	0	0
    54	130	144	-0.032638889
    54	86	140	0.075642857
    54	56	132	0.190151515
    54	29	66	0.392121212
    54	12	50	0.5098
    54	7	46	0.460434783
    54	0	0	0
    58.5	130	146	-0.03760274
    58.5	86	104	0.086730769
    58.5	56	98	0.280102041
    58.5	29	72	0.501111111
    58.5	12	54	0.697222222
    58.5	7	42	0.833333333
    58.5	0	0	1
    63	130	146	-0.032191781
    63	86	104	0.096153846
    63	56	72	0.261388889
    63	29	54	0.457592593
    63	12	40	0.6765
    63	7	24	0.75
    63	0	0	1
    67.5	130	200	0
    67.5	86	96	0.093958333
    67.5	56	72	0.283194444
    67.5	29	58	0.507068966
    67.5	12	42	0.74452381
    67.5	7	34	0.807352941
    67.5	0	0	1
    72	130	230	0
    72	86	96	0.081697917
    72	56	74	0.296756757
    72	29	58	0.520689655
    72	12	44	0.784318182
    72	7	30	0.810333333
    72	0	0	1
    76.5	130	156	0
    76.5	86	96	0.112244898
    76.5	56	82	0.339512195
    76.5	29	56	0.51125
    76.5	12	42	0.765714286
    76.5	7	34	0.807352941
    76.5	0	0	1
    81	130	142	0
    81	86	98	0.131020408
    81	56	80	0.31375
    81	29	62	0.550322581
    81	12	38	0.763157895
    81	7	34	0.818823529
    81	0	0	1
    85.5	130	152	-0.007736842
    85.5	86	98	0.128061224
    85.5	56	74	0.333918919
    85.5	29	58	0.6196
    85.5	12	54	0.769814815
    85.5	7	36	0.860555556
    85.5	0	0	1
    90	130	152	-0.018059211
    90	86	102	0.123039216
    90	56	80	0.333375
    90	29	60	0.581666667
    90	12	48	0.759791667
    90	7	36	0.860555556
    90	0	0	1
    
    96	130	nan	-.03
    96	86	nan	0.13
    96	56	74	0.3
    96	29	50	0.47
    96	12	40	0.75
    96	7	28	0.891578947
    96	0	0	1
    
    108	130	nan	-0.03
    108	86	nan	0.13
    108	56	76	0.32
    108	29	50	0.5
    108	12	38	0.761578947
    108	7	30	0.862666667
    108	0	0	1
    
    120	130	nan	-0.03
    120	86	nan	0.13
    120	56	76	0.33
    120	29	46	0.46
    120	12	42	0.767619048
    120	7	34	0.851176471
    120	0	0	1
    
    132	130	nan	-0.03
    132	86	nan	0.12
    132	56	74	0.31
    132	29	52	0.48
    132	12	38	0.755526316
    132	7	30	0.862666667
    132	0	0	1
    
    144	130	nan	-0.021008929
    144	86	nan	0.1
    144	56	72	0.29
    144	29	54	0.48
    144	12	42	0.767619048
    144	7	34	0.851176471
    144	0	0	1
    
    156	130	nan	-0.03
    156	86	nan	0.09
    156	56	76	0.28
    156	29	52	0.48
    156	12	36	0.725555556
    156	7	22	0.823636364
    156	0	0	1
    
    168	130	nan	-0.03
    168	86	nan	0.052816327
    168	56	74	0.27
    168	29	52	0.49
    168	12	38	0.743157895
    168	7	34	0.851176471
    168	0	0	1
    
    180	130	nan	-0.03
    180	86	nan	0.04235
    180	56	76	0.24
    180	29	52	0.470576923
    180	12	42	0.756190476
    180	7	36	0.888888889
    180	0	0	1
    
    192	130	nan	-0.027683824
    192	86	nan	0.028522727
    192	56	76	0.21
    192	29	58	0.49
    192	12	46	0.74173913
    192	7	34	0.851176471
    192	0	0	1
    
    204	130	nan	-0.021005952
    204	86	nan	0
    204	56	78	0.19
    204	29	60	0.46
    204	12	42	0.750714286
    204	7	28	0.857142857
    204	0	0	1
    
    216	130	nan	-0.028755556
    216	86	nan	-0.03
    216	56	68	0.2
    216	29	52	0.42
    216	12	38	0.705789474
    216	7	22	0.791363636
    216	0	0	1
    
    228	130	nan	0.002554348
    228	86	nan	-0.03
    228	56	68	0.12
    228	29	52	0.37
    228	12	42	0.705789474
    228	7	28	0.840357143
    228	0	0	1
    
    240	130	nan	-0.040540541
    240	86	nan	-0.081694444
    240	56	nan	0.067727273
    240	29	54	0.3
    240	12	30	0.643
    240	7	20	0.788
    240	0	0	1
    
    252	130	nan	-0.033898305
    252	86	nan	-0.057446809
    252	56	nan	-0.015
    252	29	58	0.25
    252	12	36	0.555555556
    252	7	22	0.759545455
    252	0	0	1
    
    264	130	150	0
    264	86	186	-0.05
    264	56	122	-0.06
    264	29	122	0.12
    264	12	32	0.4484375
    264	7	24	0.705833333
    264	0	0	1
    
    276	130	142	0.003309859
    276	86	112	-0.05
    276	56	112	-0.09
    276	29	100	0
    276	12	70	0.235277778
    276	7	22	0.449090909
    276	0	0	1
    
    288	130	150	-0.009333333
    288	86	114	-0.05
    288	56	95	-0.11
    288	29	nan	-0.11
    288	12	nan	-.03
    288	7	nan	0.171136364
    288	0	0	1
    
    300	130	150	0
    300	86	104	-0.05
    300	56	74	-0.136756757
    300	29	46	-0.102173913
    300	12	56	-0.1
    300	7	46	-0.030434783
    300	0	0	0
    
    312	130	158	0
    312	86	106	-0.031075472
    312	56	78	-0.12
    312	29	50	-0.14
    312	12	36	-0.097222222
    312	7	nan	-0.045454545
    312	0	0	0
    
    324	130	154	0
    324	86	98	-0.04
    324	56	66	-0.124772727
    324	29	29	-0.15
    324	12	nan	-.13
    324	7	nan	-.1
    324	0	0	0
    
    336	130	154	0
    336	86	98	-0.04
    336	56	66	-0.125
    336	29	29	-0.17
    336	12	nan	-.17
    336	7	nan	-.13
    336	0	0	0
    
    348	130	154	0
    348	86	98	-0.06
    348	56	66	-0.15
    348	29	29	-0.18
    348	12	nan	-.18
    348	7	nan	-.13
    348	0	0	0
    
    360	130	154	0
    360	86	98	-0.07
    360	56	66	-0.16
    360 29	29	-0.2
    360	12	nan	-.19
    360	7	nan	-.19
    360	0	0	-.13
     
    500	130	154	-.5
    500	86	98	-0.6
    500	56	66	-0.65
    500 29	29	-0.7
    500	12	nan	-.75
    500	7	nan	-.8
    500	0	0	-.88];

xs_slope  = up_slopes(:,1:2);
y_slope = up_slopes(:,4);
x_range_up(1).range = [0:.1:max(up_slopes(:,2))]; %S before I
x_range_up(2).range = [0:.1:max(up_slopes(:,1))];
% xs_fit_slope = [30 150]; %S before I


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Slope of Decrease of Spontaneous firing for each I and S (post-PR = S)
down_slopes = [156.0000   -0.0500  130.0000  131.0000
    156.0000         0         0   85.0000
    156.0000         0         0   55.0000
    156.0000         0         0   40.0000
    156.0000         0         0   13.4000
    156.0000         0         0    5.8800
    156.0000         0         0         0
    168.0000   -0.0800  130.0000  131.0000
    168.0000         0         0   85.0000
    168.0000         0         0   55.0000
    168.0000         0         0   40.0000
    168.0000         0         0   13.4000
    168.0000         0         0    5.8800
    168.0000         0         0         0
    180.0000   -0.08  130.0000  131.0000
    180.0000         0         0   85.0000
    180.0000         0         0   55.0000
    180.0000         0         0   40.0000
    180.0000         0         0   13.4000
    180.0000         0         0    5.8800
    180.0000         0         0         0
    192.0000   -0.09  130.0000  131.0000
    192.0000   -0.0400   80.0000   85.0000
    192.0000         0         0   55.0000
    192.0000         0         0   40.0000
    192.0000         0         0   13.4000
    192.0000         0         0    5.8800
    192.0000         0         0         0
    204.0000   -0.12  130.0000  131.0000
    204.0000   -0.0300   80.0000   85.0000
    204.0000         0         0   55.0000
    204.0000         0         0   40.0000
    204.0000         0         0   13.4000
    204.0000         0         0    5.8800
    204.0000         0         0         0
    216.0000   -0.15  130.0000  131.0000
    216.0000   -0.0900   80.0000   85.0000
    216.0000   -0.0200   40.0000   55.0000
    216.0000         0         0   30.0000
    216.0000         0         0   13.4000
    216.0000         0         0    5.8800
    216.0000         0         0         0
    228.0000   -0.21  130.0000  131.0000
    228.0000   -0.1000   80.0000   85.0000
    228.0000   -0.0400   40.0000   55.0000
    228.0000         0         0   30.0000
    228.0000         0         0   13.4000
    228.0000         0         0    5.8800
    228.0000         0         0         0
    240.0000   -0.21  130.0000  131.0000
    240.0000   -0.1300   80.0000   85.0000
    240.0000   -0.0700   40.0000   55.0000
    240.0000         0         0   30.0000
    240.0000         0         0   13.4000
    240.0000         0         0    5.8800
    240.0000         0         0         0
    252.0000   -0.2125  130.0000  131.0000
    252.0000   -0.1479   80.0000   85.0000
    252.0000   -0.0800   40.0000   55.0000
    252.0000   -0.0800   52.0000   30.0000
    252.0000   -0.0300   30.0000   13.4000
    252.0000   -0.0493   18.0000    5.8800
    252.0000         0         0         0
    264.0000   -0.2389  130.0000  131.0000
    264.0000   -0.1912   80.0000   85.0000
    264.0000   -0.1223   40.0000   55.0000
    264.0000   -0.0800   52.0000   30.0000
    264.0000   -0.0600   32.0000   13.4000
    264.0000   -0.0400         0    5.8800
    264.0000         0         0         0
    276.0000   -0.2500  142.0000  131.0000
    276.0000   -0.2400   80.0000   85.0000
    276.0000   -0.1500   40.0000   55.0000
    276.0000   -0.0900   72.0000   30.0000
    276.0000   -0.0500   34.0000   13.4000
    276.0000   -0.0400   20.0000    5.8800
    276.0000         0         0         0
    288.0000   -0.2900  140.0000  131.0000
    288.0000   -0.2700   60.0000   85.0000
    288.0000   -0.1672   40.0000   55.0000
    288.0000   -0.1200   64.0000   30.0000
    288.0000   -0.0500   34.0000   13.4000
    288.0000   -0.0400   20.0000    5.8800
    288.0000         0         0         0
    300.0000   -0.2900  152.0000  131.0000
    300.0000   -0.2900   80.0000   85.0000
    300.0000   -0.2200   40.0000   55.0000
    300.0000   -0.1600   20.0000   30.0000
    300.0000   -0.0672   36.0000   13.4000
    300.0000   -0.0600         0    5.8800
    300.0000         0         0         0
    312.0000   -0.3200  152.0000  131.0000
    312.0000   -0.3300   80.0000   85.0000
    312.0000   -0.2673   40.0000   55.0000
    312.0000   -0.2000   19.0000   30.0000
    312.0000   -0.0941         0   13.4000
    312.0000   -0.0659         0    5.8800
    312.0000         0         0         0
    324.0000   -0.3600  152.0000  131.0000
    324.0000   -0.3600   80.0000   85.0000
    324.0000   -0.2933   40.0000   55.0000
    324.0000   -0.2400   20.0000   30.0000
    324.0000   -0.1059         0   13.4000
    324.0000   -0.0642         0    5.8800
    324.0000         0         0         0
    336.0000   -0.4000  151.0000  131.0000
    336.0000   -0.3900   75.0000   85.0000
    336.0000   -0.3600   40.0000   55.0000
    336.0000   -0.2800   20.0000   30.0000
    336.0000   -0.1300   26.0000   13.4000
    336.0000   -0.1029   24.0000    5.8800
    336.0000         0         0         0
    348.0000   -0.4500  154.0000  131.0000
    348.0000   -0.4200   60.0000   85.0000
    348.0000   -0.4000   40.0000   55.0000
    348.0000   -0.3500   20.0000   30.0000
    348.0000   -0.1700   28.0000   13.4000
    348.0000   -0.0986   24.0000    5.8800
    348.0000         0         0         0
    360.0000   -0.4700  148.0000  131.0000
    360.0000   -0.5000   60.0000   85.0000
    360.0000   -0.5200   40.0000   55.0000
    360.0000   -0.4800   26.0000   30.0000
    360.0000   -0.2000   30.0000   13.4000
    360.0000   -0.1098   20.0000    5.8800
    360.0000   -0.1000         0         0
    500.0000   -3.00  148.0000  131.0000
    500.0000   -2.000   60.0000   85.0000
    500.0000   -1.00   40.0000   55.0000
    500.0000   -0.700   26.0000   30.0000
    500.0000   -0.7000   30.0000   13.4000
    500.0000   -0.6098   20.0000    5.8800
    500.0000   -0.6000         0         0];


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%
% adapted from pp_sp_code_results_v2.m
%Started 4/25/21 CRS
%Last Updated 4/26/21 CRS
%adapted from pp_sp_demo_vX.m version files into a single file
%Adding: 4/26/21 - (1) interpolating instead of fitting smooth funcitons to how
%values change over time (2) do a 2D rms between kathy's data and the new
%data
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

full_elim_drop_1 = [250 250 250  250   50 12 1 250 250 250  250   50 12 
    -60 -60 -60 -60 -60 -40 0     -60 -60 -60 -60 -60 -40 ];

Ss = [132 85 55 30 14 5 0 130 86 56 29   12 7.05 ];
I_switch_facils = [30 32 35 35 35 44  44 30 32 35 35 35 44 ];

pr_bend_per_S = [140 100 70 50 32 20 0 140 100 70 50 32 20 ];
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%save('model_params_5_4_21.mat','I_in_t_block','x_range_tblck','xs_slope','y_slope','x_range_up','down_slopes','xs_range_prt_elim','prt_elim_S','I_S_t_PS_SP',)


  
%% All predictions algorithm:

             %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
            %Interpolated inputs given I_cur and X_cur
            %I
            x_range_tblck(1).range = min(I_in_t_block (:,1)):.1:max(I_in_t_block (:,1));
            x_range_tblck(2).range =  min(I_in_t_block (:,2)):.1:max(I_in_t_block (:,2));
            %  [pred_t_block] = interp_SI_funs(I_in_t_block (:,1),I_in_t_block (:,2),x_range_tblck, I_cur,0); % Cannot predict outside of range of x input..
            [pred_t_block] = interp_SI_funs(I_in_t_block (:,[ 2 1]),I_in_t_block (:,3),x_range_tblck,[I_cur S_cur],0);
            
            %S,I
            [pred_up_slope] = interp_SI_funs(xs_slope,y_slope,x_range_up,[S_cur I_cur],0);
            
            [pred_down_slope] = interp_SI_funs(down_slopes(:,[4 1]),down_slopes(:,2),xs_range_prt_elim,[I_cur min(130,S_cur)],0);
            
            %I, S
            [pred_prt_elim_1] = interp_SI_funs(prt_elim_S(:,[2 1]),prt_elim_S(:,3),xs_range_prt_elim,[I_cur min(130,S_cur)],0);
            
            %I, S
            [pred_prt_elim_2] = interp_SI_funs(prt_elim_S(:,[2 1]),prt_elim_S(:,4),xs_range_prt_elim,[I_cur min(130,S_cur)],0);
            
            %Pred facilitation scaling and slopes:
            [pred_facil_slope] = interp_SI_funs(I_S_t_PS_SP(:,[2 1]),I_S_t_PS_SP(:,3),xs_range_prt_elim,[I_cur min(130,S_cur)],0);
            [pred_facil_scale] = interp_SI_funs(I_S_t_PS_SP(:,[2 1]),I_S_t_PS_SP(:,4),xs_range_prt_elim,[I_cur min(130,S_cur)],0);
            
            %Pred facil window:
            x_range_S(1).range = [min(Ss):.1:max(Ss)];
            [I_switch_fac] = interp_SI_funs(Ss,I_switch_facils,x_range_S,S_cur,0);
            [FE_1] = interp_SI_funs(Ss,full_elim_drop_1(1,:),x_range_S,S_cur,0);
            
            [FE_2] = interp_SI_funs(Ss,full_elim_drop_1(2,:),x_range_S,S_cur,0);
            
            [pr_bend] = interp_SI_funs(Ss,pr_bend_per_S,x_range_S,S_cur,0);
            
            
               full_elim_drop_1 = [FE_1 FE_2];
           
               
            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
            
            cur_m1= pred_up_slope;
            
            prt_elims(1) = pred_prt_elim_1;
            prt_elims(2) = pred_prt_elim_2;
            
            
            t_block = pred_t_block;% I_in_t_block(44*(S_idx -1)+I_idx,3);%pred_t_block;
            
            t_SP_PS = [pred_facil_slope pred_facil_scale];
            
            
            %%%pr_bend = pr_bend_per_S(n_rats);
            %I_shifted = I_cur*max(1,I_shift_scale_S(n_rats));
            [corr_ipi] = all_pp_block_calc(I_cur,prs_cur,S_cur,prt_elims,full_elim_drop_1,t_block, t_SP_PS );
            corr_ipi(prs_cur == 0) = 0;
            
            
            if  (I_cur >= 312)
                corr_ipi = zeros(1,length(prs_cur));
            end
            [val bend_idx] = min(abs(prs_cur - pr_bend));
            % pr_bend = pr_bend_down;
            before_bend = (cur_m1.*prs_cur).*(prs_cur <= pr_bend);
            
            
            
            %Slope down check:
            if I_cur >= 156%n_curs >=16
                cur_slope = pred_down_slope;
                down_slope = max(-S_cur,(cur_slope.*(prs_cur - pr_bend)));
            else
                down_slope = 0;
            end
       
     %PRINT OUT
% % %         sprintf('F: tb %s, m_up %s, m_d %s,pt1 %s, pt2 %s, fac1 %s, fac2 %s,FE1 %s, FE2 %s, PR_b %s', ...
% % %       num2str(pred_t_block),  num2str(pred_up_slope), num2str(pred_down_slope),...
% % %       num2str(pred_prt_elim_1),  num2str(pred_prt_elim_2), ...
% % %      num2str(pred_facil_slope),num2str(pred_facil_scale),num2str(FE_1),num2str(FE_2),num2str(pr_bend))   
% % %  
            
            
            %SP scales Ps down Ps blocks S but that rule can be use to make S go up     
            if (I_cur <= I_switch_fac) %I_switch_facil(n_rats))
                tot_pred1 =  corr_ipi;%  + max(-S_cur,(down_slope + cur_m1.*prs_cur(bend_idx)));%.*(prs_cur >pr_bend);
                
            else
                P_sub_val_by_S = corr_ipi(bend_idx);
                P_max_add = (max(min(0,-cur_m1.*prs_cur(bend_idx)),corr_ipi - P_sub_val_by_S )); %maybe also scale it
                
                tot_pred1 = before_bend  + P_max_add.*(prs_cur >=  pr_bend)  + max(-S_cur,(down_slope + cur_m1.*prs_cur(bend_idx))).*(prs_cur >pr_bend);
                
            end




end

function [corr_ipi] = all_pp_block_calc(I_cur,prs,S,prt_elims_tmp,full_elim_drop,t_block,   t_SP_PS )
%t_block is the calculated t_pp (or t FR = 1*PR --> PR/2)
%I_cur = all_cur(n_cur);
%%%%%% FIXES:
% Fixed merge at transition point p_prt to p_full - 4/16/21 12:42 AM


%%
%See Fit: figure(1); plot(all_cur, t_block_f_pred,'b.','markersize',10);

%%% Relating parameters to cathodic and anodic phase axon effects:
%%% Assume that cathodic phase of stimulation increases linearly with
%%% current amplitude and look at what anodic must do in comparison.


% Keep fixed
cath_eff = (I_cur/230).^2;%(all_cur/230)*scale;
facill_eq = sigmf(I_cur,[.1 55]);
%figure(1); plot(I_cur,facill_eq)

an_eff = t_block.*cath_eff;%facill_eq;
t_block = an_eff./cath_eff;%facill_eq;
t_block= min(t_block, 200);
%an_eff_switch = 5.25;% Shift from suppressing to fully shutting down axon (keep fixed)


%%%%%%
%Facillitation
%add_wind = 3.5;%%5; %1: .2;%

corr_ipi = prs./ceil(t_block./(1e3./prs));
bend_nums = ceil(t_block./(1e3./prs));

facill_eq = .3;


%Main block rule

%%%%%%%%%
%%%%%%%%%
%%%%%%%%% part elimination
clear perc_elim_tmp

%How many bends to do part elim at:
num_bends = max(3,ceil(t_block/(1e3./600)));
if (an_eff > 5)
    num_bends = 3;
end
%For each bend do the partial elim
for n_bend = 1:(num_bends-1)
    if n_bend == 1
        pr_full_elim = (1e3./t_block);%sim_data(1).key_pts(n_cur,(n_bend-1)*2+2+1);%%%
        t_pp_full12 = t_block;
    end
    
    if isempty(find(bend_nums == n_bend+1))
        ipi_switch = (t_block/n_bend);%(prs(min(find(bend_nums == 2)))*2);
        pr_full_elim = (1e3./ipi_switch) ;
        
    else
        ipi_switch = t_block/n_bend;%ms
        pr_full_elim = (1e3./ipi_switch);%pps
    end
    
    if n_bend == 1
        %%%part_elim_frac =  part_elim_f(I_cur);
        part_elim_frac = prt_elims_tmp(1);
    else
        %%%part_elim_frac =   part_elim_n_np1(I_cur,0.025,.175,.8,8.5,105);
        part_elim_frac = prt_elims_tmp(2);
    end
    
    pr_prt_elim = pr_full_elim -  min(.99,part_elim_frac).*(1e3./t_block);
    %sim_data(1).key_pts(n_cur,(n_bend-1)*2+2+1);
    t_pp_prt = 1e3/pr_prt_elim;
    t_pp_full = 1e3/(pr_full_elim); %ms
    
    
    scale_up = 5*(((I_cur+full_elim_drop(2))/300).^(4));%*full_elim_drop(2)));
    if (an_eff > 5 ) %I = 200 for sim with no spont firing
        %Rule that does partial elimination where the tPP builds and
        %so partial elimination becomes full elimination and 2/3
        %becomes stronger
        
        if n_bend == 2
            % Full kill is like deep partial elimination:
            scale_fact = 200/full_elim_drop(1);%/max(1,S);
            perc_elim_tmp(n_bend,:) = scale_fact*((1-(((1e3./prs) - t_pp_full)/(t_pp_prt - t_pp_full))).^(3).*((t_pp_prt - 1e3./prs) >= 0));
            
        else
            if  (S<4)
                %                 First dip is dynamics getting trapped in a loop modeled
                %                 like this (b/c pulses get looped with selves):
                tmp_perc = ((((1e3./prs) - t_pp_full)/(t_pp_prt - t_pp_full))).*...
                    (((1e3./prs - t_pp_full) > 0) & ((t_pp_prt - 1e3./prs ) >= 0));
                perc_elim_tmp(n_bend,:) = ceil(tmp_perc*scale_up);%round(tmp_perc*scale_up);%scales up when amplitude really high
            else
                
                perc_elim_tmp(n_bend,:) = min(1,(1+scale_up)*(1 - (((1e3./prs) - t_pp_full)/(t_pp_prt - t_pp_full)))).*...
                    (((1e3./prs - t_pp_full) >= 0) & ((t_pp_prt - 1e3./prs ) >= 0));
            end
        end
        
    else
        
        perc_elim_tmp(n_bend,:) = min(1,(1+scale_up)*(1 - (((1e3./prs) - t_pp_full)/(t_pp_prt - t_pp_full)))).*...
            (((1e3./prs - t_pp_full) >= 0) & ((t_pp_prt - 1e3./prs ) >= 0));
        
    end
end
%Get part and full elim part of bend
perc_elim = sum(perc_elim_tmp,1);

if (an_eff > 5)
    corr_ipi = (prs./(min(ceil(t_pp_full12./((1e3./prs))),2) + perc_elim));%.*facill_eq;%.*(sol_temp).*(sol_temp >= .75);
    
else
    corr_ipi = (prs./(ceil(t_pp_full12./((1e3./prs))) + perc_elim));%.*facill_eq;%.*(sol_temp).*(sol_temp >= .75);
end


%Compare what a mod does:
% S = 16;
prs_tmp = prs;
prs_tmp(prs_tmp == 0) = 1000;
IPI =1e3./prs_tmp;


if S == 0
    S_scale = 40;
    ISI = round(1e3/5);
    mod_tot = lcm(round(ISI),round(IPI));
    t_p =  S_scale*t_SP_PS(1);
    
    mod_tot = lcm(round(ISI),round(IPI));
    p_elim_s = min(1,.65+((mod_tot./IPI).*t_p)./mod_tot);
    
    p_elim_s(prs ==0) = 0;
    if (t_SP_PS(1) >= .04)
        corr_ipi2 =corr_ipi.*(p_elim_s)*t_SP_PS(2) ;
    else
        corr_ipi2 =corr_ipi.*( p_elim_s > .8).*( p_elim_s)*t_SP_PS(2) ;
    end
else

    ISI = 1e3/S;

    effect_w_prs = min(1,t_SP_PS(1).*prs);
    corr_ipi(prs ==0) = 0;

    S_scale = .33;%5
    %end
    corr_ipi2 =(corr_ipi).*t_SP_PS(2).*( effect_w_prs >.8).*(effect_w_prs) + ....
        (corr_ipi).*S_scale.*effect_w_prs.*( effect_w_prs <=.8);

end
%  figure(902); plot(prs,corr_ipi2)
% plot(prs, effect_w_prs.*corr_ipi.*( effect_w_prs <=.8))
corr_ipi = corr_ipi2; %sol_temp.*corr_ipi.*(sol_temp >= .75);
end

function [pred_z] = interp_SI_funs(xs,y,x_range,xs_fit,plot_it)

if size(xs,1) < size(xs,2)
    xs = xs';
end
if size(y,1) < size(y,2)
    y = y';
end
if size(xs_fit,1) > size(xs_fit,2)
    xs_fit = xs_fit';
end

%Remove nans:
xs_clean = xs(find(~isnan(y)),:);
y_clean = y(find(~isnan(y)));

%1D
if size(xs_fit,2) == 1
    xq = x_range(1).range;
    pred_z = interp1(xs,y,xs_fit);
    if plot_it
        
        yq = interp1(xs,y,xq);
        [diff_1 pred_idx] = min(abs(xq - xs_fit));
        pred_z = yq(pred_idx);
        figure(1);
        plot(xs,y,'bo'); hold on;
        plot(xq,yq,'k');
        plot(xs_fit,pred_z,'r.','markersize',10);
        
        if (diff_1 > 5)
            warning('Prediction is out of interpolation boundaries');
        end
    end
    ylabel('Firing Rate (sps)'); xlabel('Pulse Rate (pps)')
else
    %2D
    x1_range = x_range(1).range;
    x2_range = x_range(2).range;
    
    pred_z = griddata(xs_clean(:,1),xs_clean(:,2),y_clean,xs_fit(2),xs_fit(1));
    [diff_1 closest_idx_1] = min(abs(x1_range - xs_fit(1)));
    [diff_2 closest_idx_2] = min(abs(x2_range - xs_fit(2)));
    if ((diff_1 - max(x1_range)) < 5)
        xs_fit(1) = x1_range(closest_idx_1);
    end
    if ((diff_2 - max(x2_range)) < 5)
        xs_fit(2) = x2_range(closest_idx_2);
    end
    pred_z = griddata(xs_clean(:,1),xs_clean(:,2),y_clean,xs_fit(2),xs_fit(1));
    
    if plot_it
        [diff_1 closest_idx_1] = min(abs(x1_range - xs_fit(1)));
        [diff_2 closest_idx_2] = min(abs(x2_range - xs_fit(2)));
        
        [xq,yq] = meshgrid(x2_range,x1_range); %reverses x,y axis
        zq = griddata(xs_clean(:,1),xs_clean(:,2),y_clean,xq,yq);
        %[x1_range(closest_idx_1),x2_range(closest_idx_2)]
        pred_z = zq(closest_idx_1,closest_idx_2);
        
        figure(2);
        mesh(yq,xq,zq); hold on;
        plot3(xs_clean(:,2),xs_clean(:,1),y_clean,'bo');
        plot3(xs_fit(1),xs_fit(2),pred_z,'r.','markersize',30)
        
        xlabel('SR')
        ylabel('I')
        zlabel('Function')
        
        if (diff_1 > 5)| (diff_2 > 5)
            warning('Prediction is out of interpolation boundaries');
            
        end
    end
end

if (isnan(pred_z))
    warning('Prediction is out of interpolation boundaries');
end
end
